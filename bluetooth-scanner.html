<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Scanner</title>
</head>
<body>
    <h1>Bluetooth Device Scanner</h1>
    <button id="scanButton">Scan for Bluetooth Devices</button>
    <pre id="output"></pre>

    <script>
        const scanButton = document.getElementById('scanButton');
        const output = document.getElementById('output');

        async function connectAndQueryServices(device) {
            try {
                // Connect to GATT server
                const server = await device.gatt.connect();
                output.textContent += 'Connected to GATT server.\n';

                // Discover primary services
                const services = await server.getPrimaryServices();
                output.textContent += `Found ${services.length} primary services:\n`;

                for (const service of services) {
                    output.textContent += `Service UUID: ${service.uuid}\n`;

                    // Optionally, discover characteristics for each service
                    const characteristics = await service.getCharacteristics();
                    output.textContent += `  Characteristics (${characteristics.length}):\n`;
                    for (const characteristic of characteristics) {
                        output.textContent += `    - UUID: ${characteristic.uuid}\n`;
                        // You could read values here if needed: await characteristic.readValue();
                    }
                }

                // Disconnect when done (optional)
                // device.gatt.disconnect();
            } catch (error) {
                output.textContent += `Error in connectAndQueryServices: ${error.message}\n`;
            }
        }

        scanButton.addEventListener('click', async () => {
            try {
                // Check if Web Bluetooth is supported
                if (!navigator.bluetooth) {
                    output.textContent = 'Web Bluetooth API is not supported in this browser.';
                    return;
                }

                // Request device with optional filters
                // Here, we're scanning for any device; you can add filters like { services: ['battery_service'] }
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true, // Scans for all nearby devices
                    optionalServices: ['generic_access'] // Optional: allows access to basic services
                });

                // Display device info
                output.textContent = `Device found:\nName: ${device.name}\nID: ${device.id}\n`;

                // Call the new function to connect and query services
                await connectAndQueryServices(device);
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>