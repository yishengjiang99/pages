<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Editor Chat</title>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
        }

        main {
            width: 100%;
            max-width: 600px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #chat-window {
            flex: 1;
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            border-bottom: 1px solid #ddd;
        }

        .message {
            margin-bottom: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
        }

        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .bot-message {
            background-color: #e9ecef;
            color: black;
            align-self: flex-start;
            margin-right: auto;
        }

        .bot-message video,
        .user-message video {
            width: 100%;
            max-width: 300px;
            margin-top: 8px;
            border-radius: 4px;
        }

        #input-area {
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 8px;
        }

        #file-input,
        #chat-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #upload-button,
        #send-button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #upload-button:hover,
        #send-button:hover {
            background-color: #0056b3;
        }

        @media (max-width: 600px) {
            main {
                max-width: 100%;
                border-radius: 0;
            }

            #chat-window {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <main>
        <div id="chat-window"></div>
        <div id="input-area">
            <input type="file" id="file-input" accept="video/*">
            <button id="upload-button">Upload Video</button>
            <input type="text" id="chat-input" placeholder="Describe the video edit...">
            <button id="send-button">Send</button>
        </div>
    </main>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        let loaded = false;
        async function loadFFmpeg() {
            if (!loaded) {
                await ffmpeg.load();
                loaded = true;
            }
        }

        let videoFileData = null;
        let currentFileName = 'input.mp4';

        const token = prompt('Enter your xAI API token');
        if (!token) {
            alert('xAI API token is required to use the chat features.');
        }

        const systemPrompt = 'You are a helpful video editing assistant. Use the provided tools to apply filters and edits to the uploaded video. Respond with descriptions of actions and call tools when appropriate to perform the edits.';
        let messages = [{ role: 'system', content: systemPrompt }];

        const tools = [
            {
                type: 'function',
                function: {
                    name: 'resize_video',
                    description: 'Resize the video to the specified width and height while maintaining aspect ratio if needed. This filter scales the video dimensions.',
                    parameters: {
                        type: 'object',
                        properties: {
                            width: { type: 'integer', description: 'The new width in pixels. Must be a positive even number for most codecs.' },
                            height: { type: 'integer', description: 'The new height in pixels. Must be a positive even number for most codecs. Use -1 to auto-scale based on width.' }
                        },
                        required: ['width', 'height']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'crop_video',
                    description: 'Crop a region of the video starting from the specified top-left corner with given width and height. Useful for removing borders or focusing on a part of the frame.',
                    parameters: {
                        type: 'object',
                        properties: {
                            x: { type: 'integer', description: 'The x-coordinate of the top-left corner of the crop area.' },
                            y: { type: 'integer', description: 'The y-coordinate of the top-left corner of the crop area.' },
                            width: { type: 'integer', description: 'The width of the crop area in pixels.' },
                            height: { type: 'integer', description: 'The height of the crop area in pixels.' }
                        },
                        required: ['x', 'y', 'width', 'height']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'rotate_video',
                    description: 'Rotate the video by the specified angle in degrees. Common for correcting orientation, e.g., 90 for clockwise, -90 for counter-clockwise.',
                    parameters: {
                        type: 'object',
                        properties: {
                            angle: { type: 'number', description: 'The rotation angle in degrees. Positive for clockwise, negative for counter-clockwise.' }
                        },
                        required: ['angle']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'add_text',
                    description: 'Overlay text on the video at a specified position with customizable size and color. Note: This assumes a default font is available in FFmpeg.',
                    parameters: {
                        type: 'object',
                        properties: {
                            text: { type: 'string', description: 'The text to overlay on the video.' },
                            x: { type: 'integer', description: 'The x-position for the text (default: 10).', default: 10 },
                            y: { type: 'integer', description: 'The y-position for the text (default: 10).', default: 10 },
                            fontsize: { type: 'integer', description: 'The font size (default: 24).', default: 24 },
                            color: { type: 'string', description: 'The font color (default: white).', default: 'white' }
                        },
                        required: ['text']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'trim_video',
                    description: 'Trim the video to keep only the portion between the start and end times. Times can be in seconds or HH:MM:SS format.',
                    parameters: {
                        type: 'object',
                        properties: {
                            start: { type: 'string', description: 'The start time (e.g., 00:00:10 or 10).' },
                            end: { type: 'string', description: 'The end time (e.g., 00:00:30 or 30).' }
                        },
                        required: ['start', 'end']
                    }
                }
            },
            {
                type: 'function',
                function: {
                    name: 'adjust_speed',
                    description: 'Change the playback speed of the video and audio. A factor >1 speeds up, <1 slows down.',
                    parameters: {
                        type: 'object',
                        properties: {
                            speed: { type: 'number', description: 'The speed factor (e.g., 2 for double speed, 0.5 for half speed).' }
                        },
                        required: ['speed']
                    }
                }
            }
        ];

        const toolFunctions = {
            resize_video: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-vf', `scale=${args.width}:${args.height}`, '-c:a', 'copy', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (resized):', false, videoUrl);
                return 'Video resized successfully.';
            },
            crop_video: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-vf', `crop=${args.width}:${args.height}:${args.x}:${args.y}`, '-c:a', 'copy', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (cropped):', false, videoUrl);
                return 'Video cropped successfully.';
            },
            rotate_video: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-vf', `rotate=${args.angle}*PI/180`, '-c:a', 'copy', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (rotated):', false, videoUrl);
                return 'Video rotated successfully.';
            },
            add_text: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-vf', `drawtext=text='${args.text}':x=${args.x || 10}:y=${args.y || 10}:fontsize=${args.fontsize || 24}:fontcolor=${args.color || 'white'}`, '-c:a', 'copy', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (text added):', false, videoUrl);
                return 'Text added to video successfully.';
            },
            trim_video: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-ss', args.start, '-to', args.end, '-c', 'copy', 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (trimmed):', false, videoUrl);
                return 'Video trimmed successfully.';
            },
            adjust_speed: async (args) => {
                await loadFFmpeg();
                ffmpeg.FS('writeFile', currentFileName, videoFileData);
                await ffmpeg.run('-i', currentFileName, '-filter:v', `setpts=PTS/${args.speed}`, '-filter:a', `atempo=${args.speed}`, 'output.mp4');
                const data = ffmpeg.FS('readFile', 'output.mp4');
                videoFileData = new Uint8Array(data);
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                addMessage('Processed video (speed adjusted):', false, videoUrl);
                return 'Video speed adjusted successfully.';
            }
        };

        function addMessage(text, isUser = false, videoUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
            messageDiv.innerHTML = `<p>${text}</p>`;
            
            if (videoUrl) {
                const video = document.createElement('video');
                video.src = videoUrl;
                video.controls = true;
                messageDiv.appendChild(video);
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function callAPI(currentMessages) {
            try {
                const response = await fetch('https://api.grok.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: 'grok-beta',
                        messages: currentMessages,
                        tools: tools,
                        tool_choice: 'auto'
                    })
                });
                const data = await response.json();
                const msg = data.choices[0].message;

                if (msg.content) {
                    addMessage(msg.content, false);
                    currentMessages.push({ role: 'assistant', content: msg.content });
                }

                if (msg.tool_calls) {
                    currentMessages.push({ role: 'assistant', content: null, tool_calls: msg.tool_calls });
                    for (const call of msg.tool_calls) {
                        const funcName = call.function.name;
                        const args = JSON.parse(call.function.arguments);
                        const result = await toolFunctions[funcName](args);
                        currentMessages.push({
                            role: 'tool',
                            tool_call_id: call.id,
                            name: funcName,
                            content: result
                        });
                    }
                    await callAPI(currentMessages);
                }
            } catch (error) {
                addMessage('Error communicating with xAI API: ' + error.message, false);
            }
        }

        uploadButton.addEventListener('click', async () => {
            if (fileInput.files.length === 0) {
                alert('Please select a video file.');
                return;
            }
            const file = fileInput.files[0];
            addMessage('Uploading video...', true);
            videoFileData = await fetchFile(file);
            const videoUrl = URL.createObjectURL(file);
            addMessage('Original video uploaded:', false, videoUrl);
            messages.push({ role: 'user', content: 'Video uploaded and ready for editing.' });
            await callAPI(messages);
        });

        sendButton.addEventListener('click', async () => {
            const text = chatInput.value.trim();
            if (!text || !videoFileData) {
                if (!videoFileData) alert('Please upload a video first.');
                return;
            }
            addMessage(text, true);
            chatInput.value = '';
            messages.push({ role: 'user', content: text });
            await callAPI(messages);
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
    </script>
</body>
</html>