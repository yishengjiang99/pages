<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kerned Width via Glyph Loop (opentype.js)</title>
  <script src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 100%;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    label {
      font-size: 14px;
    }

    input[type="text"],
    input[type="range"] {
      padding: 6px;
      font-size: 16px;
      max-width: 100%;
    }

    svg {
      width: 100%;
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
      margin: 10px 0;
    }

    #widthDisplay {
      font-family: monospace;
      margin-top: 10px;
      word-wrap: break-word;
    }

    @media (min-width: 600px) {
      .controls {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
      }

      .controls>div {
        flex: 1;
        min-width: 150px;
      }
    }
  </style>
</head>

<body>

  <div class="controls">
    <div>
      <label for="input1">Variable 1:</label>
      <input type="text" id="input1" value="variable1">
    </div>
    <div>
      <label for="input2">Variable 2:</label>
      <input type="text" id="input2" value="variable2">
    </div>
    <div>
      <label for="fontSize">Font Size: <span id="sizeValue">24</span>px</label>
      <input type="range" id="fontSize" min="12" max="72" value="24" step="1">
    </div>
  </div>

  <svg height="200" id="mySvg"></svg>

  <div id="widthDisplay">
    Width of variable1: <span id="widthValue1">0</span>px<br>
    Width of variable2: <span id="widthValue2">0</span>px
  </div>

  <script>
    const ttfUrl = '/fonts/NotoSansMath-Regular.ttf';
    const renderFamilyName = 'Noto Sans Math Local';
    const GAP = 10;
    const LETTER_SPACING = 0;

    const input1 = document.getElementById('input1');
    const input2 = document.getElementById('input2');
    const fontSizeSlider = document.getElementById('fontSize');
    const sizeValue = document.getElementById('sizeValue');
    const svg = document.getElementById('mySvg');
    const widthValue1 = document.getElementById('widthValue1');
    const widthValue2 = document.getElementById('widthValue2');

    const text1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text1.setAttribute('x', '10');
    text1.setAttribute('y', '50');
    text1.setAttribute('fill', 'black');
    svg.appendChild(text1);

    const text2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text2.setAttribute('y', '50');
    text2.setAttribute('fill', 'black');
    svg.appendChild(text2);

    const widthText1 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    widthText1.setAttribute('x', '10');
    widthText1.setAttribute('y', '100');
    widthText1.setAttribute('font-family', 'Arial');
    widthText1.setAttribute('font-size', '14');
    widthText1.setAttribute('fill', 'gray');
    svg.appendChild(widthText1);

    const widthText2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    widthText2.setAttribute('x', '10');
    widthText2.setAttribute('y', '120');
    widthText2.setAttribute('font-family', 'Arial');
    widthText2.setAttribute('font-size', '14');
    widthText2.setAttribute('fill', 'gray');
    svg.appendChild(widthText2);

    const guide = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    guide.setAttribute('x1', '10');
    guide.setAttribute('y1', '60');
    guide.setAttribute('x2', '10');
    guide.setAttribute('y2', '160');
    guide.setAttribute('stroke', '#ddd');
    guide.setAttribute('stroke-dasharray', '4 3');
    svg.appendChild(guide);

    let otFont = null;

    function kernedAdvanceWidth(font, text, fontSize, { kerning = true, letterSpacing = 0 } = {}) {
      const glyphs = font.stringToGlyphs(text);
      const scale = fontSize / font.unitsPerEm;
      let width = 0;

      for (let i = 0; i < glyphs.length; i++) {
        const g = glyphs[i];
        const adv = (g && typeof g.advanceWidth === 'number') ? g.advanceWidth : 0;
        width += adv * scale;

        if (kerning && i < glyphs.length - 1) {
          const kern = font.getKerningValue(g, glyphs[i + 1]) || 0;
          width += kern * scale;
        }

        if (letterSpacing && i < glyphs.length - 1) {
          width += letterSpacing;
        }
      }
      return width;
    }

    function updateRendering() {
      if (!otFont) return;

      const var1 = input1.value || '';
      const var2 = input2.value || '';
      const fontSize = Number(fontSizeSlider.value);
      sizeValue.textContent = fontSize;

      text1.setAttribute('font-family', renderFamilyName);
      text2.setAttribute('font-family', renderFamilyName);
      text1.setAttribute('font-size', fontSize);
      text2.setAttribute('font-size', fontSize);
      text1.textContent = var1;
      text2.textContent = var2;

      const width1 = kernedAdvanceWidth(otFont, var1, fontSize, {
        kerning: true,
        letterSpacing: LETTER_SPACING
      });

      const width2 = kernedAdvanceWidth(otFont, var2, fontSize, {
        kerning: true,
        letterSpacing: LETTER_SPACING
      });

      const x2 = 10 + width1 + GAP;
      text2.setAttribute('x', x2);

      widthValue1.textContent = width1.toFixed(2);
      widthValue2.textContent = width2.toFixed(2);
      widthText1.textContent = `Width of "${var1}": ${width1.toFixed(2)}px`;
      widthText2.textContent = `Width of "${var2}": ${width2.toFixed(2)}px`;

      guide.setAttribute('x1', '10');
      guide.setAttribute('x2', '10');
    }

    async function loadExactFontAndMetrics() {
      const face = new FontFace(renderFamilyName, `url(${ttfUrl})`);
      await face.load();
      document.fonts.add(face);

      const resp = await fetch(ttfUrl, { mode: 'cors' });
      if (!resp.ok) throw new Error(`Font fetch failed: HTTP ${resp.status}`);
      const buf = await resp.arrayBuffer();
      otFont = opentype.parse(buf);

      await document.fonts.ready;
      updateRendering();
      requestAnimationFrame(updateRendering);
    }

    loadExactFontAndMetrics().catch(err => console.error(err));

    fontSizeSlider.addEventListener('input', updateRendering);
    input1.addEventListener('input', updateRendering);
    input2.addEventListener('input', updateRendering);
  </script>

<!-- NAVIGATION INJECTED -->
<style>
  body { margin: 0; font-family: Arial, sans-serif; }
  header {
    background: #333; color: white; padding: 10px 20px;
    display: flex; justify-content: space-between; align-items: center;
    position: sticky; top: 0; z-index: 1000;
  }
  header a { color: white; text-decoration: none; font-weight: bold; }
  .menu-btn { background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
  .drawer {
    height: 100%; width: 250px; position: fixed; top: 0; left: -250px;
    background: #444; overflow-x: hidden; transition: 0.3s; padding-top: 60px;
    z-index: 999;
  }
  .drawer.open { left: 0; }
  .drawer a {
    padding: 10px 20px; text-decoration: none; color: white; display: block;
  }
  .drawer a:hover { background: #575757; }
  main { margin: 20px; }
</style>
<header>
  <a href="/index.html">← Back to Index</a>
  <button class="menu-btn" onclick="toggleDrawer()">☰ Menu</button>
</header>
<div id="drawer" class="drawer">
  <a href="__test__/terrapin.html">terrapin.html</a>
<a href="afd-slogan-generator.html">afd-slogan-generator.html</a>
<a href="blinker.html">blinker.html</a>
<a href="compose.html">compose.html</a>
<a href="edit-wave-info.html">edit-wave-info.html</a>
<a href="l2r.html">l2r.html</a>
<a href="midi2svg.html">midi2svg.html</a>
<a href="mlogo.html">mlogo.html</a>
<a href="mocr.html">mocr.html</a>
<a href="paint.html">paint.html</a>
<a href="radar.html">radar.html</a>
<a href="reinforcement-policy-neuron-network.html">reinforcement-policy-neuron-network.html</a>
<a href="sprite-detect.html">sprite-detect.html</a>
<a href="sprite.html">sprite.html</a>
<a href="stolzmonat.html">stolzmonat.html</a>
<a href="strwidth.html">strwidth.html</a>
<a href="svgtrace.html">svgtrace.html</a>
<a href="synth.html">synth.html</a>
<a href="terrapin.html">terrapin.html</a>
<a href="tetris.html">tetris.html</a>
<a href="timer.html">timer.html</a>
<a href="westerwald.html">westerwald.html</a>
</div>
<script>
  function toggleDrawer() {
    document.getElementById('drawer').classList.toggle('open');
  }
</script>
</body>

</html>