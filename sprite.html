<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sprite Sheet Player + MPEG Export</title>
<style>
  body {
    background:#0f1115;
    color:#eee;
    font-family:sans-serif;
    margin:0;
    padding:20px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    -webkit-user-select:none;
    user-select:none;
  }
  h2 { margin: 0 0 10px 0; text-align:center; }
  canvas {
    background:#000;
    border:1px solid #444;
    image-rendering:pixelated;
    display:block;
    max-width:95vw;
    width:95%;
    height:auto;
    margin:0 auto;
  }
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
  }
  label {font-size:14px;}
  input,button {font-size:14px;padding:6px 10px;}
</style>
</head>
<body>
<h2>Sprite Player + MPEG Export</h2>

<input type="file" id="fileInput" accept="image/*"><br>
<label>Rows: <input type="number" id="rows" value="1" min="1" style="width:60px"></label>
<label>Cols: <input type="number" id="cols" value="1" min="1" style="width:60px"></label>
<label>FPS: <input type="range" id="fps" min="1" max="60" value="10"></label>
<span id="fpsLabel">10 fps</span><br>

<div class="controls">
  <button id="playBtn">Play</button>
  <button id="pauseBtn" disabled>Pause</button>
  <button id="recordBtn" disabled>Start Record</button>
  <button id="stopRecBtn" disabled>Stop & Download MPEG</button>
</div>

<canvas id="canvas"></canvas>

<script>
let img=null,frame=0,playing=false,rows=1,cols=1,fps=10;
const cvs=document.getElementById('canvas'),ctx=cvs.getContext('2d');
const playBtn=document.getElementById('playBtn'),pauseBtn=document.getElementById('pauseBtn');
const recBtn=document.getElementById('recordBtn'),stopRecBtn=document.getElementById('stopRecBtn');
const fpsSlider=document.getElementById('fps'),fpsLabel=document.getElementById('fpsLabel');
let recorder,chunks=[];

fpsSlider.oninput=()=>{fps=parseInt(fpsSlider.value);fpsLabel.textContent=fps+' fps';};

document.getElementById('fileInput').onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    img=new Image();
    img.onload=()=>{
      const fw=img.width/cols,fh=img.height/rows;
      cvs.width=fw;
      cvs.height=fh;
      resizeCanvas();
      recBtn.disabled=false;
      playBtn.disabled=false;
      drawFrame();
    };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);
};
document.getElementById('rows').oninput=e=>{rows=parseInt(e.target.value)||1; if(img) resetFrame();}
document.getElementById('cols').oninput=e=>{cols=parseInt(e.target.value)||1; if(img) resetFrame();}

function resetFrame(){
  frame=0;
  const fw=img.width/cols,fh=img.height/rows;
  cvs.width=fw; cvs.height=fh;
  resizeCanvas();
  drawFrame();
}

function drawFrame(){
  if(!img)return;
  const fw=img.width/cols,fh=img.height/rows;
  const x=(frame%cols)*fw,y=Math.floor(frame/cols)*fh;
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.drawImage(img,x,y,fw,fh,0,0,cvs.width,cvs.height);
}

let loop;
function play(){
  playing=true; playBtn.disabled=true; pauseBtn.disabled=false;
  let last=0;
  loop=requestAnimationFrame(function anim(ts){
    if(!playing)return;
    if(ts-last>1000/fps){
      frame=(frame+1)%(rows*cols);
      drawFrame(); last=ts;
    }
    loop=requestAnimationFrame(anim);
  });
}
function pause(){playing=false; playBtn.disabled=false; pauseBtn.disabled=true;}

playBtn.onclick=play;
pauseBtn.onclick=pause;

// Recording
recBtn.onclick=()=>{
  const stream=cvs.captureStream(fps);
  recorder=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
  chunks=[];
  recorder.ondataavailable=e=>{if(e.data.size)chunks.push(e.data);};
  recorder.onstop=saveVideo;
  recorder.start();
  recBtn.disabled=true; stopRecBtn.disabled=false;
  if(!playing)play();
};
stopRecBtn.onclick=()=>{
  recorder.stop();
  recBtn.disabled=false; stopRecBtn.disabled=true;
  pause();
};
function saveVideo(){
  const blob=new Blob(chunks,{type:'video/webm'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='sprite.mp4'; // actually WebM format
  a.click();
}

// Responsive canvas scaling
function resizeCanvas(){
  const maxW=window.innerWidth*0.95;
  const scale=Math.min(maxW/cvs.width,1);
  cvs.style.width=cvs.width*scale+'px';
  cvs.style.height=cvs.height*scale+'px';
}
window.addEventListener('resize',resizeCanvas);
</script>
</body>
</html>
