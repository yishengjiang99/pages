<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Cart-Pole Ramp Policy NN</title>
<style>
  :root{
    --bg:#0f1720;
    --panel:#0b1220;
    --accent:#6ee7b7;
    --muted:#9aa6b2;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6;font-family:sans-serif;}
  #app{display:flex;flex-direction:column;height:100%;}
  #topbar{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;font-size:14px;}
  #main{display:flex;flex:1;gap:6px;padding:6px;box-sizing:border-box;}
  @media(max-width:900px){#main{flex-direction:column;}}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:10px;padding:6px;flex:1;display:flex;flex-direction:column;}
  #simPanel{flex:1.2;max-height:220px;}
  #uiPanel{flex:1;min-height:160px;overflow:auto;}
  canvas{width:100%;height:100%;display:block;border-radius:6px;background:#071015;}
  #footerControls{position:fixed;left:0;right:0;bottom:0;padding:6px;display:flex;gap:6px;justify-content:center;background:rgba(0,0,0,0.4);}
  #footerControls button{flex:1;padding:10px;border-radius:8px;}
  button{background:#133;border:1px solid #355;color:#dff7eb;font-weight:600;font-size:14px;}
  button.primary{background:linear-gradient(90deg,var(--accent),#4fd19a);color:#052018;}
  .stat{font-size:12px;color:var(--muted)}
  .bigStat{font-size:15px;font-weight:700;color:var(--accent)}
  .networkCanvas{height:220px}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div>Cart-Pole Ramp — Policy NN</div>
    <div class="stat" id="episodeBadge">Episode: 0</div>
  </div>

  <div id="main">
    <div class="panel" id="simPanel">
      <canvas id="simCanvas"></canvas>
      <div style="display:flex;justify-content:space-between;margin-top:4px;">
        <div>
          <button id="manualBtn">Manual</button>
          <button id="policyBtn" class="primary">Policy</button>
        </div>
        <div class="stat">Best:<span class="bigStat" id="bestScore">0</span></div>
      </div>
    </div>

    <div class="panel" id="uiPanel">
      <label>Network</label>
      <canvas id="netCanvas" class="networkCanvas"></canvas>
      <div id="info" style="font-size:12px;color:var(--muted);margin-top:6px;white-space:pre-line;">Ready.</div>
    </div>
  </div>

  <div id="footerControls">
    <button id="leftTouch">◀ Left</button>
    <button id="rightTouch">Right ▶</button>
  </div>
</div>

<script>
const simCanvas=document.getElementById('simCanvas');
const netCanvas=document.getElementById('netCanvas');
const simCtx=simCanvas.getContext('2d');
const netCtx=netCanvas.getContext('2d');
function resize(){
  simCanvas.width=simCanvas.clientWidth*devicePixelRatio;
  simCanvas.height=simCanvas.clientHeight*devicePixelRatio;
  netCanvas.width=netCanvas.clientWidth*devicePixelRatio;
  netCanvas.height=netCanvas.clientHeight*devicePixelRatio;
}
window.addEventListener('resize',resize);resize();

let slope=6*Math.PI/180;
const cart={M:1,m:0.1,L:0.6};
const X_MIN=-3,X_MAX=3.5,dt=1/60,g=9.81;
let state={x:-2.5,vx:0,theta:0.05,thetaDot:0};

class PolicyNet{
  constructor(inp=6,hid=8){this.i=inp;this.h=hid;this.W1=new Float32Array(hid*inp).map(()=>Math.random()*0.4-0.2);this.b1=new Float32Array(hid);this.W2=new Float32Array(hid).map(()=>Math.random()*0.4-0.2);this.b2=0;}
  forward(a){let h=new Float32Array(this.h);for(let i=0;i<this.h;i++){let s=this.b1[i];for(let j=0;j<this.i;j++)s+=this.W1[i*this.i+j]*a[j];h[i]=Math.tanh(s);}let o=this.b2;for(let i=0;i<this.h;i++)o+=this.W2[i]*h[i];return{y:Math.tanh(o),h};}
}
const policy=new PolicyNet();
let bestScore=0;document.getElementById('bestScore').innerText=bestScore;

function stepPhysics(force){
  const F=force*10;
  const {M,m,L}=cart;
  let{theta,thetaDot,vx}=state;
  const num=g*Math.sin(theta+slope)+Math.cos(theta)*(-F-m*L*thetaDot*thetaDot*Math.sin(theta));
  const den=L*(4/3-(m*Math.cos(theta)**2)/(M+m));
  const thetaDD=num/den;
  const xDD=(F+m*L*(thetaDot*thetaDot*Math.sin(theta)-thetaDD*Math.cos(theta)))/(M+m);
  state.vx+=xDD*dt;state.x+=state.vx*dt;state.thetaDot+=thetaDD*dt;state.theta+=state.thetaDot*dt;
}

let mode='policy',manualForce=0,episode=0,steps=0;
document.getElementById('manualBtn').onclick=()=>{mode='manual';};
document.getElementById('policyBtn').onclick=()=>{mode='policy';};
document.getElementById('leftTouch').onpointerdown=()=>manualForce=-1;
document.getElementById('leftTouch').onpointerup=()=>manualForce=0;
document.getElementById('rightTouch').onpointerdown=()=>manualForce=1;
document.getElementById('rightTouch').onpointerup=()=>manualForce=0;

function resetEpisode(){
  state={x:-2.5,vx:0,theta:(Math.random()-0.5)*0.2,thetaDot:0};
  steps=0;episode++;document.getElementById('episodeBadge').innerText="Episode: "+episode;
}
function draw(){
  simCtx.setTransform(1,0,0,1,0,0);simCtx.clearRect(0,0,simCanvas.width,simCanvas.height);
  const w=simCanvas.width,h=simCanvas.height,DPR=devicePixelRatio;
  const pxpm=(w*0.7)/(X_MAX-X_MIN);
  const ox=w*0.15,oy=h*0.8;
  const len=(X_MAX-X_MIN)*pxpm;
  simCtx.strokeStyle="rgba(150,255,200,0.15)";simCtx.lineWidth=4;
  simCtx.beginPath();simCtx.moveTo(ox,oy);simCtx.lineTo(ox+Math.cos(-slope)*len,oy+Math.sin(-slope)*len);simCtx.stroke();
  const cx=ox+(state.x-X_MIN)*pxpm*Math.cos(-slope);
  const cy=oy+(state.x-X_MIN)*pxpm*Math.sin(-slope);
  simCtx.save();simCtx.translate(cx,cy);simCtx.rotate(-slope);
  simCtx.fillStyle="#2ca58d";simCtx.fillRect(-25*DPR,-12*DPR,50*DPR,24*DPR);
  const tipX=Math.sin(-(state.theta+slope))*80,tipY=-Math.cos(-(state.theta+slope))*80;
  simCtx.strokeStyle="#ffd66b";simCtx.lineWidth=4;simCtx.beginPath();simCtx.moveTo(0,-12*DPR);simCtx.lineTo(tipX,tipY-12*DPR);simCtx.stroke();
  simCtx.restore();
}
function drawNetwork(inputs,hid){
  const w=netCanvas.width,h=netCanvas.height,DPR=devicePixelRatio;
  netCtx.setTransform(1,0,0,1,0,0);netCtx.clearRect(0,0,w,h);
  const margin=40*DPR;
  const inputX=margin,hiddenX=w/2,outputX=w-margin;
  for(let i=0;i<policy.i;i++){
    for(let j=0;j<policy.h;j++){
      netCtx.strokeStyle="rgba(80,120,140,0.3)";
      netCtx.beginPath();netCtx.moveTo(inputX,margin+i*20*DPR);netCtx.lineTo(hiddenX,margin+j*20*DPR);netCtx.stroke();
    }
  }
  for(let j=0;j<policy.h;j++){
    netCtx.strokeStyle="rgba(80,120,140,0.3)";
    netCtx.beginPath();netCtx.moveTo(hiddenX,margin+j*20*DPR);netCtx.lineTo(outputX,h/2);netCtx.stroke();
  }
  for(let i=0;i<policy.i;i++){
    netCtx.fillStyle="white";netCtx.beginPath();netCtx.arc(inputX,margin+i*20*DPR,5*DPR,0,Math.PI*2);netCtx.fill();
  }
  for(let j=0;j<policy.h;j++){
    const a=hid?hid[j]:0;const c=Math.floor((a*127+128));netCtx.fillStyle=`rgb(${c},${200-c},180)`;netCtx.beginPath();netCtx.arc(hiddenX,margin+j*20*DPR,6*DPR,0,Math.PI*2);netCtx.fill();
  }
  netCtx.fillStyle="#ffd66b";netCtx.beginPath();netCtx.arc(outputX,h/2,8*DPR,0,Math.PI*2);netCtx.fill();
}

// Training/simulation speed control
let training=true;
const TRAIN_EPISODES=200;
const FAST_STEPS=20; // steps per frame during training

function loop(){
  if(training){
    for(let k=0;k<FAST_STEPS;k++){
      let res=policy.forward([Math.sin(state.theta),Math.cos(state.theta),state.thetaDot,(state.x-X_MIN)/(X_MAX-X_MIN)*2-1,Math.tanh(state.vx/5),Math.sin(slope)]);
      stepPhysics(res.y);
      steps++;
      if(Math.abs(state.theta)>0.5||state.x<X_MIN||state.x>X_MAX){
        if(steps>bestScore){bestScore=steps;document.getElementById('bestScore').innerText=bestScore;}
        resetEpisode();
        if(episode>=TRAIN_EPISODES){training=false;resetEpisode();}
      }
    }
    draw();
  } else {
    let res=policy.forward([Math.sin(state.theta),Math.cos(state.theta),state.thetaDot,(state.x-X_MIN)/(X_MAX-X_MIN)*2-1,Math.tanh(state.vx/5),Math.sin(slope)]);
    stepPhysics(res.y);
    draw();drawNetwork(null,res.h);
    steps++;
    if(Math.abs(state.theta)>0.5||state.x<X_MIN||state.x>X_MAX){resetEpisode();}
  }
  requestAnimationFrame(loop);
}
resetEpisode();loop();
</script>
</body>
</html>
